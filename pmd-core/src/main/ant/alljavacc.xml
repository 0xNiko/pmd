<project name="pmd" default="alljavacc" basedir="../../">

    <property name="javacc-home.path" value="target/lib" />

    <property name="tmp-package" value="net.sourceforge.pmd.lang.ast.dummy" />

    <property name="tmp-package.dir" value="${target}/net/sourceforge/pmd/lang/ast/dummy" />

    <property name="base-ast-package" value="net.sourceforge.pmd.lang.ast" />
    <property name="base-ast-package.dir" value="${target}/net/sourceforge/pmd/lang/ast" />

    <property name="target-package" value="${base-ast-package}.impl.javacc" />
    <property name="target-package.dir" value="${base-ast-package.dir}/impl/javacc" />


    <target name="alljavacc"
            description="Generates all JavaCC aspects within PMD"
            depends="checkUpToDate,init,dummyjjtree,cleanup" />

    <target name="checkUpToDate">
        <uptodate property="javaccBuildNotRequired" targetfile="${target}/last-generated-timestamp">
            <srcfiles dir="etc/grammar" includes="*.jj*"/>
        </uptodate>
        <echo message="up to date check: javaccBuildNotRequired=${javaccBuildNotRequired}"/>
    </target>

    <target name="init" unless="javaccBuildNotRequired">
        <mkdir dir="${javacc-home.path}" />
        <copy file="${javacc.jar}" tofile="${javacc-home.path}/javacc.jar" />

        <mkdir dir="${target}"/>
        <touch file="${target}/last-generated-timestamp"/>
    </target>

    <target name="cleanup">
        <delete dir="${javacc-home.path}" />
    </target>

    <target name="dummyjjtree" description="Generates the reusable JavaCC aspects" unless="javaccBuildNotRequired">

        <delete dir="${tmp-package.dir}" />
        <mkdir dir="${tmp-package.dir}" />
        <echo>Using JavaCC home: ${javacc-home.path}</echo>
        <jjtree target="etc/grammar/dummy.jjt"
                outputdirectory="${tmp-package.dir}"
                javacchome="${javacc-home.path}" />

        <!-- Generate CharStream interface -->
        <javacc usercharstream="true"
                target="${tmp-package.dir}/dummy.jj"
                outputdirectory="${tmp-package.dir}"
                javacchome="${javacc-home.path}" />

        <!-- Generate ASCII w/ Unicode Escapes CharStream implementation -->
        <javacc usercharstream="false"
                unicodeinput="false"
                javaunicodeescape="true"
                static="false"
                target="${tmp-package.dir}/dummy.jj"
                outputdirectory="${tmp-package.dir}"
                javacchome="${javacc-home.path}" />

        <replace file="${tmp-package.dir}/JavaCharStream.java"
                 token="${tmp-package}"
                 value="${target-package}">
            <fileset dir="${tmp-package.dir}">
            </fileset>
        </replace>


        <!-- Patch JavaCharStream        -->

        <antcall target="patch-char-stream">
            <param name="cs.prefix" value="Java" />
        </antcall>

        <delete dir="${tmp-package.dir}" />

    </target>


    <target name="patch-char-stream">

        <replace file="${tmp-package.dir}/${cs.prefix}CharStream.java"
                 token="${cs.prefix}CharStream"
                 value="${cs.prefix}CharStreamBase"/>
        <replace file="${tmp-package.dir}/${cs.prefix}CharStream.java"
                 token="class ${cs.prefix}CharStreamBase"
                 value="abstract class ${cs.prefix}CharStreamBase implements ${base-ast-package}.CharStream" />
        <replace file="${tmp-package.dir}/${cs.prefix}CharStream.java"
                 token="char c;"
                 value="char c; beforeReadChar();" />
        <replace file="${tmp-package.dir}/${cs.prefix}CharStream.java"
                 token="/** Read a character. */"
                 value="protected void beforeReadChar() { }protected boolean doEscape() { return true; }" />
        <replace file="${tmp-package.dir}/${cs.prefix}CharStream.java"
                 token="if ((buffer[bufpos] = c = ReadByte()) == '\\')"
                 value="if ((buffer[bufpos] = c = ReadByte()) == '\\' &amp;&amp; doEscape())" />

        <move overwrite="true"
              file="${tmp-package.dir}/${cs.prefix}CharStream.java"
              tofile="${target-package.dir}/${cs.prefix}CharStreamBase.java" />


    </target>


</project>
